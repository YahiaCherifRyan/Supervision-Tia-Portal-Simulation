<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supervision Industrielle S7-300</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f0f2f5; color: #333; }
    
    /* Barre d'entête */
    .header { 
      background: #004a99; 
      color: white; 
      padding: 15px 20px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
    }
    .header h2 { margin: 0; font-size: 1.2rem; }
    .user-profile { text-align: right; }
    .role-tag { 
      font-size: 0.7rem; 
      background: rgba(255,255,255,0.2); 
      padding: 2px 8px; 
      border-radius: 10px; 
      text-transform: uppercase; 
    }

    .container { max-width: 500px; margin: 20px auto; padding: 15px; }

    /* Alerte pour les opérateurs */
    .alert-read-only { 
      background: #fff3cd; 
      color: #856404; 
      padding: 12px; 
      border-radius: 8px; 
      margin-bottom: 20px; 
      border: 1px solid #ffeeba;
      display: none;
      text-align: center;
      font-weight: bold;
    }

    /* Cartes de contrôle */
    .card { 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
      margin-bottom: 20px; 
      text-align: center;
    }
    .card label { display: block; margin-bottom: 15px; font-weight: bold; color: #666; }

    /* Le Voyant LED */
    .led-box { margin: 20px 0; }
    .led { 
      width: 60px; 
      height: 60px; 
      background-color: #b0b0b0; /* Gris par défaut */
      border-radius: 50%; 
      margin: 0 auto; 
      border: 4px solid #333;
      transition: all 0.3s ease;
    }
    .led.active { 
      background-color: #2ecc71; /* Vert */
      box-shadow: 0 0 20px #2ecc71; 
    }
    #status-text { margin-top: 10px; font-weight: bold; font-size: 1.1rem; }

    /* Affichage Valeur Numérique */
    .value-display { font-size: 3rem; font-weight: bold; color: #004a99; margin: 10px 0; }

    /* Boutons et Inputs */
    .admin-controls { 
      margin-top: 20px; 
      padding-top: 15px; 
      border-top: 1px dashed #eee; 
    }
    button { 
      padding: 12px 20px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: bold; 
      transition: opacity 0.2s;
    }
    .btn-on { background: #2ecc71; color: white; }
    .btn-off { background: #95a5a6; color: white; }
    .btn-send { background: #004a99; color: white; width: 100%; margin-top: 10px; }
    input[type="number"] { 
      width: 100%; 
      padding: 12px; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      box-sizing: border-box; 
      font-size: 1rem;
      text-align: center;
    }
    .logout-link { 
      display: block; 
      text-align: center; 
      margin-top: 30px; 
      color: #e74c3c; 
      text-decoration: none; 
      font-weight: bold; 
    }
  </style>
</head>
<body>

  <div class="header">
    <h2>S7-300 SUPERVISION</h2>
    <div class="user-profile">
      <span id="display-username">Chargement...</span> <br>
      <span id="display-role" class="role-tag">--</span>
    </div>
  </div>

  <div class="container">
    <div id="msg-operateur" class="alert-read-only">
      MODE LECTURE SEULE
    </div>

    <div class="card">
      <label>ÉTAT DE LA MACHINE (DB1.DBX0.0)</label>
      <div class="led-box">
        <div id="led-indicator" class="led"></div>
        <div id="status-text">HORS LIGNE</div>
      </div>
      
      <div class="admin-controls section-admin">
        <button class="btn-on" onclick="sendAction('Bouton1', true)">DÉMARRER</button>
        <button class="btn-off" onclick="sendAction('Bouton1', false)">ARRÊTER</button>
      </div>
    </div>

    <div class="card">
      <label>VALEUR ANALOGIQUE (DB1.DBW2)</label>
      <div class="value-display" id="display-nombre">0</div>
      
      <div class="admin-controls section-admin">
        <input type="number" id="input-nombre" placeholder="Nouvelle valeur...">
        <button class="btn-send" onclick="sendValue()">ENVOYER CONSIGNE</button>
      </div>
    </div>

    <a href="#" class="logout-link" onclick="handleLogout()">Déconnexion sécurisée</a>
  </div>

  <script>
    // 1. Vérification de l'utilisateur et du rôle
    async function initApp() {
      try {
        const response = await fetch('/api/user');
        if (!response.ok) { window.location.href = '/login'; return; }
        
        const user = await response.json();
        document.getElementById('display-username').textContent = user.username;
        document.getElementById('display-role').textContent = user.role;

        // Si l'utilisateur est un opérateur, on cache les contrôles
        if (user.role === 'operateur') {
          document.querySelectorAll('.section-admin').forEach(div => div.style.display = 'none');
          document.getElementById('msg-operateur').style.display = 'block';
        }
      } catch (e) {
        window.location.href = '/login';
      }
    }

    // 2. Lecture en temps réel (Polling)
    function updateData() {
      // Lecture Bouton
      fetch('/api/read/Bouton1')
        .then(res => res.json())
        .then(data => {
          const led = document.getElementById('led-indicator');
          const txt = document.getElementById('status-text');
          if (data.value) {
            led.classList.add('active');
            txt.innerText = "EN SERVICE";
            txt.style.color = "#2ecc71";
          } else {
            led.classList.remove('active');
            txt.innerText = "À L'ARRÊT";
            txt.style.color = "#95a5a6";
          }
        });

      // Lecture Nombre
      fetch('/api/read/Nombre1')
        .then(res => res.json())
        .then(data => {
          document.getElementById('display-nombre').innerText = data.value;
        });
    }

    // 3. Actions d'écriture (Admin uniquement)
    function sendAction(variable, val) {
      fetch('/api/write', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ variable: variable, value: val })
      })
      .then(res => res.json())
      .then(data => { if(data.error) alert(data.error); });
    }

    function sendValue() {
      const val = parseInt(document.getElementById('input-nombre').value);
      if (isNaN(val)) return alert("Veuillez saisir un nombre valide");
      sendAction('Nombre1', val);
    }

    async function handleLogout() {
      await fetch('/api/logout');
      window.location.href = '/login';
    }

    // Initialisation
    initApp();
    setInterval(updateData, 1000); // Mise à jour toutes les secondes
  </script>
</body>
</html>